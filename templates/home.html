<!doctype html>

<title>TMDB Viewer</title>
<h1>Testing</h1>

<html>
  <head>
    <!-- <link rel="stylesheet" href="style.css" -->
  </head>
<body>

<h2>Using the XMLHttpRequest Object</h2>

<!-- VERSION 2: Load all response by default -->
<p id="part1"></p>
<p id="part2"></p>
<div id="test1"></div>
<div id='test2'></div>
<div id='test3' class="slideshow-container"></div> 

<script>
  ///// DRIVER /////
  // Works if CORS enabled on flask server
  const url1 = "http://localhost:5000/home"; 
  var slideIndex = 0;

  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 200) {
      myRenderDOM(req); // Working: TEST 1
      tableFromJson(req); // Working: TEST 2
      divsFromJson(req); // Working: TEST 3

      showSlides(); // Working: TEST 4
    }
  };
  req.open("GET", url1, true); // asynchronous
  req.send();

  ///// FUNCTIONS /////
  function myRenderDOM(req) {
    var data = req.responseText;
    var data_json = JSON.parse(data);

    // PART 1: Get trending
    var trending = JSON.stringify(data_json.trending); //Get 'Trending'
    document.getElementById("part1").innerHTML = trending;

    // PART 2: Get airing
    var airing = JSON.stringify(data_json.airing); //Get 'Airing'
    document.getElementById("part2").innerHTML = airing;

    // TEST 1: Get the first item in airing list (PASS)
    var air1 = data_json.airing[0];
    document.getElementById("test1").innerHTML = air1;

  }
  // TEST 2: Create an html table from trending (PASS)
  function tableFromJson(req) { 
    var data = req.responseText;
    var data_json = JSON.parse(data);
    var trending = data_json.trending;

    // Extract value from table header. 
    var col = [];
    for (var i = 0; i < trending.length; i++) {
        for (var key in trending[i]) {
            if (col.indexOf(key) === -1) {
                col.push(key);
            }
        }
    }

    // Create a table
    // TODO: Convert table into div
    var table = document.createElement("table");

    // Create table header row using the extracted headers above.
    var tr = table.insertRow(-1);                   // table row.

    for (var i = 0; i < col.length; i++) {
        var th = document.createElement("th");      // table header.
        th.innerHTML = col[i];
        tr.appendChild(th);
    }

    // add json data to the table as rows.
    for (var i = 0; i < trending.length; i++) {
        tr = table.insertRow(-1);
        for (var j = 0; j < col.length; j++) {
            var tabCell = tr.insertCell(-1);
            tabCell.innerHTML = trending[i][col[j]];
        }
    }

    // Now, add the newly created table with json data, to a container.
    var divShowData = document.getElementById('test2');
    divShowData.innerHTML = "";
    divShowData.appendChild(table);
  }

  // TEST 3: Instead of table, make a list of divs
  function divsFromJson(req) {
    var data = req.responseText;
    var data_json = JSON.parse(data);
    var trending = data_json.trending;

    var div1 = document.createElement("div");

    // add json data to the table as rows.
    for (var i = 0; i < trending.length; i++) {

        var div2 = document.createElement("div"); //Item header
        // div2.class = "trend_item";
        div2.classList.add("trend_item");
        div2.innerHTML = trending[i]['title'];
        div1.appendChild(div2);

        //Image
        var img = document.createElement("img"); 
        const backdrop_path = trending[i]['backdrop_path']
        img.src = backdrop_path;
        // img.class = "trend_img";
        img.classList.add("trend_img");
        img.style.height = "250px";
        // img.innerHTML = trending[i]['backdrop_path'];
        div2.appendChild(img);

        //Release date
        var div3 = document.createElement("div"); 
        div3.innerHTML = trending[i]['release_date'];
        div2.appendChild(div3);
    }

    // Now, add the newly created table with json data, to a container.
    var divShowData = document.getElementById('test3');
    divShowData.innerHTML = "";
    divShowData.appendChild(div1);
  }

  // TEST 4: After rendering json-to-divs, show slides
  function showSlides() {
    var i;
    var trend_items = document.getElementsByClassName("trend_item");
    for (i = 0; i < trend_items.length; i++) {
      trend_items[i].style.display = "none";  
    }
    slideIndex++;
    trend_items[slideIndex-1].style.display = "block";
    setTimeout(showSlides, 2000); // Change image every 2 
  }

  

</script>

</body>
</html>